<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.104.3" />
	
	<link rel="icon" href="/images/logo.png">
	
	<title>CPL2022网络编程与多线程教程 | Corax Blog</title>
	
	

	<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://corax.com.cn/ta/socket/cover.jpg"/>
<meta name="twitter:title" content="CPL2022网络编程与多线程教程"/>
<meta name="twitter:description" content="本页面将简单介绍使用C语言进行网络编程的流程以及简单的多线程内容"/>

	<meta property="og:title" content="CPL2022网络编程与多线程教程" />
<meta property="og:description" content="本页面将简单介绍使用C语言进行网络编程的流程以及简单的多线程内容" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://corax.com.cn/ta/socket/" /><meta property="og:image" content="https://corax.com.cn/ta/socket/cover.jpg"/><meta property="article:section" content="TA" />
<meta property="article:published_time" content="2023-01-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-09T00:00:00+00:00" />



	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">

	
	<link rel="stylesheet" href="https://corax.com.cn/css/medium.ece05c3e0cb4c172303048d902f5c72734dac11b313a671c381a53648c811f4d.css" integrity="sha256-7OBcPgy0wXIwMEjZAvXHJzTawRsxOmccOBpTZIyBH00=">

	
	<link rel="stylesheet" href="https://corax.com.cn/css/additional.14f7dbd08a523bb7dd03b308a991480ea5d8d744f6229068023169de78b48922.css" integrity="sha256-FPfb0IpSO7fdA7MIqZFIDqXY10T2IpBoAjFp3ni0iSI=">

	
	
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container pr-0">
        
        <a class="navbar-brand" href="https://corax.com.cn//">

            
            <img src="/images/logo.png" alt="logo">
            
        </a>
        

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/blog">Blog</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/">About Me</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/static/imprint">Imprint</a>
                </li>
                
            </ul>
        </div>
        
    </div>
</nav>


        <div class="site-content">   
            <div class="container">
<div class="mainheading">
    <h1 class="sitetitle">Corax Blog</h1>
    <p class="lead">
         the clean blog!
    </p>
</div><div class="main-content">
        
        <div class="container">
            <div class="row">
                
                <div class="col-md-2 pl-0"><div class="share sticky-top sticky-top-offset">
    <p>Share</p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=CPL2022%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b%e4%b8%8e%e5%a4%9a%e7%ba%bf%e7%a8%8b%e6%95%99%e7%a8%8b&url=https%3a%2f%2fcorax.com.cn%2fta%2fsocket%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=https%3a%2f%2fcorax.com.cn%2fta%2fsocket%2f" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>

        <li class="ml-1 mr-1">
        <a target="_blank" href="https://www.xing.com/spi/shares/new?url=https%3a%2f%2fcorax.com.cn%2fta%2fsocket%2f" onclick="window.open(this.href, 'xing-share', 'width=550,height=435');return false;">
        <i class="fab fa-xing"></i>
        </a>
        </li>        
    </ul>

    
        <div class="sep">
        </div>				
        <ul>
            <li> 
            <a  class="small smoothscroll" href="#disqus_thread"></a>
            </li>
        </ul>
    
</div>
</div>
                                
                <div class="col-md-9 flex-first flex-md-unordered">
                    <div class="mainheading">
                        	
                        
                        
                        
                        <div class="row post-top-meta">
                            <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0 md-nopad-right">
                                <img class="author-thumb" src="/images/avator.jpg" alt="Corax">
                            </div>
                            <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left md-nopad-left">
                                <a target="_blank" class="link-dark">Corax</a><br>
                                <span class="author-description">
                                    Creator of this blog.<br>
                                    <i class="far fa-star"></i>
                                    Jan 9, 2023
                                    <i class="far fa-clock clock"></i>
                                    9 min read
                                </span>					
                            </div>
                        </div>			
                        	
                        
                                                
                        
                        <h1 class="posttitle">CPL2022网络编程与多线程教程</h1> 
                    </div>

                    
                    
                    
                        <img class="featured-image img-fluid" src="https://corax.com.cn/ta/socket/cover.jpg" alt="thumbnail for this post">
                    
                    

                    
                    <div class="article-post">
                        <p>本教程面向CPL2022期末大作业，简单介绍利用<code>WINAPI</code>进行<strong>网络编程</strong>的环境配置和基础使用，同时还会附带一些简单的<strong>多线程</strong>内容</p>
<h2 id="环境配置">环境配置</h2>
<h3 id="通用配置">通用配置</h3>
<p>C语言利用<code>WINAPI</code>进行网络编程时的环境配置比较简单，首先需要引入头文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ws2tcpip.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//注意不要改变上述include的顺序，否则编译可能出warning
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下来，为了编译器能够成功链接到这两个库，只需要在C盘中找到<code>ws2_32.dll</code>文件，将它复制到项目文件夹下</p>
<p><img src="pic1.png" alt="ws2_32"></p>
<p>然后就可以在终端输入以下命令进行编译了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#需要先cd到项目目录下</span>
</span></span><span style="display:flex;"><span>gcc filename.c -o filename.exe -lws2_32
</span></span><span style="display:flex;"><span><span style="color:#75715e">#filename处输入你的源代码文件名</span>
</span></span></code></pre></div><h3 id="clion配置">CLion配置</h3>
<p>如果想要使用CLion运行你的代码，就需要自己编辑<code>CMakeList</code>，在其中加入两句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>link_libraries(<span style="color:#e6db74">ws2_32</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#e6db74">filename</span> <span style="color:#e6db74">ws2_32</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#filename同样是文件名
</span></span></span></code></pre></div><h2 id="网络编程教程">网络编程教程</h2>
<p>由于本教程使用的是<code>WINAPI</code>，因此你可以阅读<a href="https://learn.microsoft.com/zh-cn/docs//">microsoft的官方手册文档</a>来查阅你遇到的问题</p>
<h3 id="前置知识简要说明">前置知识简要说明</h3>
<h4 id="ip地址">ip地址</h4>
<p>遵循ip协议的主机在上网时具有标识自己身份的唯一ip地址，上网者可以通过ip地址访问相应的主机</p>
<h4 id="文件传输协议">文件传输协议</h4>
<p>常见有TCP和UDP两种协议，用于控制和传输文件，两者有一定的区别但对本课程此次大作业来说并不重要，感兴趣的同学可以自行查阅资料进行学习</p>
<h4 id="端口">端口</h4>
<p>每台主机上每种传输协议都有0~65535共计65536个端口，每个端口可以绑定唯一的进程用于提供服务，这65536个端口可以分为3类：<strong>周知端口</strong>，<strong>注册端口</strong>和<strong>动态端口</strong>，其中周知端口用于绑定<strong>固定的服务进程</strong>，注册端口用于绑定<strong>用户进程</strong>，动态端口用于动态分配不固定绑定的进程类型，因此在此次作业中我们使用<strong>注册端口</strong>（1024到49151）</p>
<h4 id="进程">进程</h4>
<p>进程可以简单地理解为一个程序，当一个进程与某一主机的某一端口绑定之后，访问者通过主机ip+相应端口号的形式访问时，提供服务的就是与这个端口相绑定的进程</p>
<h3 id="代码分解">代码分解</h3>
<h4 id="server">server</h4>
<p>服务端是提供网络服务的，它需要完成上述的绑定过程，使客户端可以通过ip+端口号的方式请求对应的服务</p>
<p>第一步，服务端要完成网络服务的初始化，需要指出的是所有的网络服务都存在着请求失败的风险，并且由于网络稳定性未知，此风险系数并不低，所以需要为可能出现的错误做好预案，类似于<code>malloc</code>函数如果分配内存失败就会返回空指针<code>NULL</code>，因此理论上在用到malloc函数的地方都应该判断得到的指针是否为空</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>WSADATA wsaData;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: WSAStartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-wsastartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    网络服务初始化(Web Server API)，第一个参数为需求的最低socket版本号，示例使用的是2.2版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsaData);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//如果初始化失败则报错并打印错误信息（iResult），网络编程中需要时刻注意中途可能出现的错误并给予返回信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//自带收尾工作的return 1，返回值为1表示程序未正常结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第二步，服务端需要获取自己对应注册端口的通信协议类型，地址信息等内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//为getaddrinfo函数做准备
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span><span style="color:#75715e">//IPV4地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>hints.ai_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//TCP协议
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//服务端被动绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>hints.ai_flags <span style="color:#f92672">=</span> AI_PASSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    8080表示端口号，取值范围为0~65535，但有些端口为保留端口，使用前请先查询目标端口是否被占用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    getaddrinfo函数提供从主机名到地址的独立于协议的转换，结果记录在result中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>iResult <span style="color:#f92672">=</span> getaddrinfo(NULL, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第三步，服务端需要创建一个适配相应端口信息的套接字（socket）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SOCKET listen_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    socket函数根据getaddrinfo函数返回的信息创建一个绑定到相应端口的套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>listen_socket <span style="color:#f92672">=</span> socket(result<span style="color:#f92672">-&gt;</span>ai_family, result<span style="color:#f92672">-&gt;</span>ai_socktype, result<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (listen_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第四步，服务端将本地地址和套接字绑定，也就意味着当前进程与端口绑定完成，此后获取到的端口地址信息不再会被使用，为了防止内存泄漏的风险需要将其释放</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    绑定函数将本地地址与套接字相关联
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>iResult <span style="color:#f92672">=</span> bind(listen_socket, result<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)result<span style="color:#f92672">-&gt;</span>ai_addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//绑定完成后，释放不再使用的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>freeaddrinfo(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;bind() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>    closesocket(listen_socket);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第五步，启动监听，服务端开始侦听向相应端口发起的请求</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    侦听函数将套接字置于侦听传入连接的状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (listen(listen_socket, SOMAXCONN) <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;listen() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>    closesocket(listen_socket);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下来，服务端就可以开始与客户端建立连接，下面的代码是服务端与两个客户端连接的例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//预备用户套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SOCKET client_socket[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {INVALID_SOCKET};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        accept函数允许在套接字上尝试传入连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    client_socket[i] <span style="color:#f92672">=</span> accept(listen_socket, NULL, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (client_socket[i] <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;accept() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(listen_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>至此，服务端就与客户端完成了连接的建立</p>
<h4 id="client">client</h4>
<p>相对来说，客户端需要处理的事情没有那么复杂，它只需要获取已经启动的服务端的信息，并与之连接即可</p>
<p>因此，客户端代码的第一步是初始化网络服务并获取服务端相应端口的信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>WSADATA wsadata;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsadata);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span>memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span>hints.ai_family <span style="color:#f92672">=</span> AF_UNSPEC;
</span></span><span style="display:flex;"><span>hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//127.0.0.1是特殊地址，指向当前主机，也可写作localhost，端口与服务器端口相对应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>iResult <span style="color:#f92672">=</span> getaddrinfo(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>第二步，客户端需要根据得到的信息构建服务端的套接字</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SOCKET server_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>ptr <span style="color:#f92672">=</span> result;
</span></span><span style="display:flex;"><span>server_socket <span style="color:#f92672">=</span> socket(ptr<span style="color:#f92672">-&gt;</span>ai_family, ptr<span style="color:#f92672">-&gt;</span>ai_socktype, ptr<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (server_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>    closesocket(server_socket);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最后，客户端尝试与服务端进行连接，同样为了避免内存泄露，此处可以释放不再会用到的服务端端口信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    MethodName: connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    connect函数建立与指定套接字的连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (connect(server_socket, ptr<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)ptr<span style="color:#f92672">-&gt;</span>ai_addrlen) <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>    SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;connect() failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>    closesocket(server_socket);
</span></span><span style="display:flex;"><span>    WSACleanup();
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>freeaddrinfo(result);
</span></span></code></pre></div><h4 id="信息收发">信息收发</h4>
<p>由于收发消息两端通用，这里就以客户端为例，分别使用<code>send</code>和<code>recv</code>函数进行信息的发送和接收</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>printf(<span style="color:#e6db74">&#34;please input a string.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>memset(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, buf)){
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> send(server_socket, buf, strlen(buf), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Bytes send: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> recv(server_socket, buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Bytes received: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Connection closing ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;recv failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="完整代码">完整代码</h3>
<p>下面给出的示例代码实现了服务端向两个客户端提供服务，客户端输入一串字符串，发送给服务端，服务端将其转化为大写后传回给客户端，客户端进行打印</p>
<h4 id="serverc">server.c</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    https://learn.microsoft.com/zh-cn/docs//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    可参考WINAPI官方文档手册
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ws2tcpip.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;This is the server.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    WSADATA wsaData;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: WSAStartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-wsastartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        网络服务初始化(Web Server API)，第一个参数为需求的最低socket版本号，示例使用的是2.2版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsaData);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果初始化失败则报错并打印错误信息（iResult），网络编程中需要时刻注意中途可能出现的错误并给予返回信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//自带收尾工作的return 1，返回值为1表示程序未正常结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//为getaddrinfo函数做准备
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//IPV4地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//TCP协议
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//服务端被动绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_flags <span style="color:#f92672">=</span> AI_PASSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        8080表示端口号，取值范围为0~65535，但有些端口为保留端口，使用前请先查询目标端口是否被占用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        getaddrinfo函数提供从主机名到地址的独立于协议的转换，结果记录在result中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> getaddrinfo(NULL, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SOCKET listen_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        socket函数根据getaddrinfo函数返回的信息创建一个绑定到相应端口的套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    listen_socket <span style="color:#f92672">=</span> socket(result<span style="color:#f92672">-&gt;</span>ai_family, result<span style="color:#f92672">-&gt;</span>ai_socktype, result<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (listen_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        绑定函数将本地地址与套接字相关联
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> bind(listen_socket, result<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)result<span style="color:#f92672">-&gt;</span>ai_addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//绑定完成后，释放不再使用的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;bind() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(listen_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        侦听函数将套接字置于侦听传入连接的状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (listen(listen_socket, SOMAXCONN) <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;listen() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(listen_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//预备用户套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SOCKET client_socket[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {INVALID_SOCKET};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            MethodName: accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            accept函数允许在套接字上尝试传入连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        client_socket[i] <span style="color:#f92672">=</span> accept(listen_socket, NULL, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (client_socket[i] <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;accept() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(listen_socket);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//连接成功建立
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    printf(<span style="color:#e6db74">&#34;connection established!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//信息接收数组以及初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    memset(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//服务端程序需要在开机时持续执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            MethodName: recv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-recv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            recv函数从连接的套接字或绑定的无连接套接字接收数据，返回值是接收到的字符数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        iResult <span style="color:#f92672">=</span> recv(client_socket[<span style="color:#ae81ff">0</span>], buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Bytes received: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> iResult; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span>)
</span></span><span style="display:flex;"><span>                    buf[i] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                MethodName: send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                send函数在连接的套接字上发送数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> iSendResult <span style="color:#f92672">=</span> send(client_socket[<span style="color:#ae81ff">0</span>], buf, iResult, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (iSendResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>                closesocket(client_socket[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>                closesocket(client_socket[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>                WSACleanup();
</span></span><span style="display:flex;"><span>                exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Connection closing ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;recv failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(client_socket[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>            closesocket(client_socket[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//第二个客户端，更多客户端应该使用for循环进行，但是如果这么处理存在怎样的问题？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        iResult <span style="color:#f92672">=</span> recv(client_socket[<span style="color:#ae81ff">1</span>], buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Bytes received: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1000</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span>)
</span></span><span style="display:flex;"><span>                    buf[i] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> iSendResult <span style="color:#f92672">=</span> send(client_socket[<span style="color:#ae81ff">1</span>], buf, iResult, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (iSendResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>                closesocket(client_socket[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>                closesocket(client_socket[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>                WSACleanup();
</span></span><span style="display:flex;"><span>                exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Connection closing ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;recv failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(client_socket[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>            closesocket(client_socket[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="clientc">client.c</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ws2tcpip.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;This is the client.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    WSADATA wsadata;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsadata);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span>    hints.ai_family <span style="color:#f92672">=</span> AF_UNSPEC;
</span></span><span style="display:flex;"><span>    hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>    hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//127.0.0.1是特殊地址，指向当前主机，也可写作localhost，端口与服务器端口相对应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    iResult <span style="color:#f92672">=</span> getaddrinfo(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SOCKET server_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    ptr <span style="color:#f92672">=</span> result;
</span></span><span style="display:flex;"><span>    server_socket <span style="color:#f92672">=</span> socket(ptr<span style="color:#f92672">-&gt;</span>ai_family, ptr<span style="color:#f92672">-&gt;</span>ai_socktype, ptr<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        connect函数建立与指定套接字的连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (connect(server_socket, ptr<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)ptr<span style="color:#f92672">-&gt;</span>ai_addrlen) <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>        SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;connect() failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;connection established!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;please input a string.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    memset(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, buf)){
</span></span><span style="display:flex;"><span>        iResult <span style="color:#f92672">=</span> send(server_socket, buf, strlen(buf), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(server_socket);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Bytes send: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        iResult <span style="color:#f92672">=</span> recv(server_socket, buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Bytes received: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Connection closing ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;recv failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(server_socket);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="有什么问题">有什么问题</h4>
<p>阻塞问题：</p>
<ul>
<li>当第一个客户端与服务端建立连接后，如果第二个客户端不进入连接，第一个客户端就无法获取服务</li>
<li>当某一个客户端连续请求服务时，它必须等待另一个客户端先请求服务才能得到响应</li>
<li>当客户端得不到服务端的响应时，客户端程序不会响应用户的操作</li>
</ul>
<h2 id="多线程教程">多线程教程</h2>
<h3 id="定义简介">定义简介</h3>
<p>多线程是一种<strong>并发处理</strong>机制，它通过特定的办法使得多个任务在直观感觉上同步进行</p>
<h3 id="思路分析">思路分析</h3>
<p>上面出现的阻塞问题分别是因为：</p>
<ul>
<li><strong>send和recv函数在发出/收到消息前会阻塞程序的继续执行</strong></li>
<li>监听客户端接入的代码先于服务代码执行</li>
<li>两个客户端享受服务具有先后次序关系</li>
<li>客户端获取用户输入的代码和接收服务端消息的代码的执行具有先后次序关系</li>
</ul>
<p>要解决这两个问题，我们可以让：</p>
<ul>
<li>服务端监听客户端接入的代码和服务客户端的代码同时执行</li>
<li>服务端服务多个客户端的代码同时执行</li>
<li>客户端获取用户输入的代码和与服务器保持连接的代码同时执行</li>
</ul>
<p>因此，具体的措施是：</p>
<ul>
<li>当服务端监听到客户端接入，就创建新的线程来服务这个客户端</li>
<li>当客户端用户输入数据后，就将数据放入队列，与服务端连接的线程保持执行，只要队列不为空就向服务端发送消息，收到消息后就将收到的数据打印到屏幕上</li>
</ul>
<h3 id="完整代码-1">完整代码</h3>
<p>现在，服务端服务的数量不再是确定的，只要不超过负荷服务端就可以动态改变服务的客户端数量</p>
<p><del>不过对于这次大作业作用不大就是了</del></p>
<h4 id="serverc-1">server.c</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    https://learn.microsoft.com/zh-cn/docs//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    可参考WINAPI官方文档手册
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ws2tcpip.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">maintainContact</span>(SOCKET<span style="color:#f92672">*</span> client_socket){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//信息接收数组以及初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    memset(buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//服务端程序需要在开机时持续执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            MethodName: recv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-recv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            recv函数从连接的套接字或绑定的无连接套接字接收数据，返回值是接收到的字符数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> iResult <span style="color:#f92672">=</span> recv(<span style="color:#f92672">*</span>client_socket, buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Bytes received: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, buf);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> iResult; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span>)
</span></span><span style="display:flex;"><span>                    buf[i] <span style="color:#f92672">-=</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                MethodName: send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                send函数在连接的套接字上发送数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> iSendResult <span style="color:#f92672">=</span> send(<span style="color:#f92672">*</span>client_socket, buf, iResult, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (iSendResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>                closesocket(<span style="color:#f92672">*</span>client_socket);
</span></span><span style="display:flex;"><span>                WSACleanup();
</span></span><span style="display:flex;"><span>                exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Connection closing ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;recv failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(<span style="color:#f92672">*</span>client_socket);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buildConnection</span>(SOCKET<span style="color:#f92672">*</span> listen_socket){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//为新客户端套接字分配空间并初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SOCKET<span style="color:#f92672">*</span> client_socket <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(SOCKET));
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>client_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            MethodName: accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-accept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            accept函数允许在套接字上尝试传入连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>client_socket <span style="color:#f92672">=</span> accept(<span style="color:#f92672">*</span>listen_socket, NULL, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>client_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;accept() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>            closesocket(<span style="color:#f92672">*</span>listen_socket);
</span></span><span style="display:flex;"><span>            WSACleanup();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//连接成功建立
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74">&#34;connection established!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//建立通信线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            MethodName: CreateThread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            创建在调用进程的虚拟地址空间内执行的线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        CreateThread(NULL, (SIZE_T)NULL, (LPTHREAD_START_ROUTINE)maintainContact, client_socket, (DWORD)<span style="color:#ae81ff">0UL</span>, NULL);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;This is the multi-thread server.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    WSADATA wsaData;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: WSAStartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-wsastartup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        网络服务初始化(Web Server API)，第一个参数为需求的最低socket版本号，示例使用的是2.2版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsaData);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果初始化失败则报错并打印错误信息（iResult），网络编程中需要时刻注意中途可能出现的错误并给予返回信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//自带收尾工作的return 1，返回值为1表示程序未正常结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//为getaddrinfo函数做准备
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//IPV4地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//TCP协议
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//服务端被动绑定
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hints.ai_flags <span style="color:#f92672">=</span> AI_PASSIVE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/ws2tcpip/nf-ws2tcpip-getaddrinfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        8080表示端口号，取值范围为0~65535，但有些端口为保留端口，使用前请先查询目标端口是否被占用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        getaddrinfo函数提供从主机名到地址的独立于协议的转换，结果记录在result中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> getaddrinfo(NULL, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SOCKET listen_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-socket
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        socket函数根据getaddrinfo函数返回的信息创建一个绑定到相应端口的套接字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    listen_socket <span style="color:#f92672">=</span> socket(result<span style="color:#f92672">-&gt;</span>ai_family, result<span style="color:#f92672">-&gt;</span>ai_socktype, result<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (listen_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock/nf-winsock-bind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        绑定函数将本地地址与套接字相关联
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> bind(listen_socket, result<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)result<span style="color:#f92672">-&gt;</span>ai_addrlen);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//绑定完成后，释放不再使用的内存空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;bind() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(listen_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-listen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        侦听函数将套接字置于侦听传入连接的状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (listen(listen_socket, SOMAXCONN) <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;listen() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        closesocket(listen_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//建立连接线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    buildConnection(<span style="color:#f92672">&amp;</span>listen_socket);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="clientc-1">client.c</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;winsock2.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ws2tcpip.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> NODE{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> request_id;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> NODE<span style="color:#f92672">*</span> next;
</span></span><span style="display:flex;"><span>}node;
</span></span><span style="display:flex;"><span>node <span style="color:#f92672">*</span>request_queue;
</span></span><span style="display:flex;"><span>SOCKET server_socket;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> cnt;
</span></span><span style="display:flex;"><span>node <span style="color:#f92672">*</span><span style="color:#a6e22e">getLastElement</span>(node <span style="color:#f92672">*</span>ptr){
</span></span><span style="display:flex;"><span>    node <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> ptr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(p<span style="color:#f92672">-&gt;</span>next)p <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>node <span style="color:#f92672">*</span><span style="color:#a6e22e">getHead</span>(node <span style="color:#f92672">*</span>ptr){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ptr<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removeHead</span>(node <span style="color:#f92672">*</span>ptr){
</span></span><span style="display:flex;"><span>    ptr<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> ptr<span style="color:#f92672">-&gt;</span>next<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">isEmpty</span>(node <span style="color:#f92672">*</span>ptr){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ptr<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">==</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">inputController</span>(){
</span></span><span style="display:flex;"><span>    request_queue <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(node));
</span></span><span style="display:flex;"><span>    request_queue<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(printf(<span style="color:#e6db74">&#34;please input the string of request NO.%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">++</span>cnt)){
</span></span><span style="display:flex;"><span>        node<span style="color:#f92672">*</span> request <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(node));
</span></span><span style="display:flex;"><span>        request<span style="color:#f92672">-&gt;</span>request_id <span style="color:#f92672">=</span> cnt;
</span></span><span style="display:flex;"><span>        memset(request<span style="color:#f92672">-&gt;</span>buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(request<span style="color:#f92672">-&gt;</span>buf));
</span></span><span style="display:flex;"><span>        request<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>        scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, request<span style="color:#f92672">-&gt;</span>buf);
</span></span><span style="display:flex;"><span>        getLastElement(request_queue)<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> request;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">maintainContact</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>isEmpty(request_queue)){
</span></span><span style="display:flex;"><span>            node <span style="color:#f92672">*</span>head <span style="color:#f92672">=</span> getHead(request_queue);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> iResult <span style="color:#f92672">=</span> send(server_socket, head<span style="color:#f92672">-&gt;</span>buf, strlen(head<span style="color:#f92672">-&gt;</span>buf), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">==</span> SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;send failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>                closesocket(server_socket);
</span></span><span style="display:flex;"><span>                WSACleanup();
</span></span><span style="display:flex;"><span>                exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            node<span style="color:#f92672">*</span> ans <span style="color:#f92672">=</span> malloc(<span style="color:#66d9ef">sizeof</span>(node));
</span></span><span style="display:flex;"><span>            ans<span style="color:#f92672">-&gt;</span>request_id <span style="color:#f92672">=</span> head<span style="color:#f92672">-&gt;</span>request_id;
</span></span><span style="display:flex;"><span>            memset(ans<span style="color:#f92672">-&gt;</span>buf, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(ans<span style="color:#f92672">-&gt;</span>buf));
</span></span><span style="display:flex;"><span>            ans<span style="color:#f92672">-&gt;</span>next <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>            iResult <span style="color:#f92672">=</span> recv(server_socket, ans<span style="color:#f92672">-&gt;</span>buf, <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;request NO.%d has been answered: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ans<span style="color:#f92672">-&gt;</span>request_id, ans<span style="color:#f92672">-&gt;</span>buf);
</span></span><span style="display:flex;"><span>            removeHead(request_queue);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;This is the client.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    WSADATA wsadata;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> iResult;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    iResult <span style="color:#f92672">=</span> WSAStartup(MAKEWORD(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), <span style="color:#f92672">&amp;</span>wsadata);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;WSAStartup failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> addrinfo <span style="color:#f92672">*</span>result, <span style="color:#f92672">*</span>ptr, hints;
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> addrinfo));
</span></span><span style="display:flex;"><span>    hints.ai_family <span style="color:#f92672">=</span> AF_UNSPEC;
</span></span><span style="display:flex;"><span>    hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>    hints.ai_protocol <span style="color:#f92672">=</span> IPPROTO_TCP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//127.0.0.1是特殊地址，指向当前主机，也可写作localhost，端口与服务器端口相对应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    iResult <span style="color:#f92672">=</span> getaddrinfo(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>, <span style="color:#e6db74">&#34;8080&#34;</span>, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iResult <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;getaddrinfo failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, iResult);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server_socket <span style="color:#f92672">=</span> INVALID_SOCKET;
</span></span><span style="display:flex;"><span>    ptr <span style="color:#f92672">=</span> result;
</span></span><span style="display:flex;"><span>    server_socket <span style="color:#f92672">=</span> socket(ptr<span style="color:#f92672">-&gt;</span>ai_family, ptr<span style="color:#f92672">-&gt;</span>ai_socktype, ptr<span style="color:#f92672">-&gt;</span>ai_protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server_socket <span style="color:#f92672">==</span> INVALID_SOCKET) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;socket() failed: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, WSAGetLastError());
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        MethodName: connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        @mannual: https://learn.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-connect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        connect函数建立与指定套接字的连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (connect(server_socket, ptr<span style="color:#f92672">-&gt;</span>ai_addr, (<span style="color:#66d9ef">int</span>)ptr<span style="color:#f92672">-&gt;</span>ai_addrlen) <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>        SOCKET_ERROR) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;connect() failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        system(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>        freeaddrinfo(result);
</span></span><span style="display:flex;"><span>        closesocket(server_socket);
</span></span><span style="display:flex;"><span>        WSACleanup();
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    freeaddrinfo(result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;connection established!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//建立服务器通信线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CreateThread(NULL, (SIZE_T)NULL, (LPTHREAD_START_ROUTINE)maintainContact, NULL, (DWORD)<span style="color:#ae81ff">0UL</span>, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//建立客户端输入输出进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    inputController();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="测试时如何联机">测试时如何联机</h2>
<p>如果你有幸能找到和你一起测试程序的<del>怨种</del>朋友，这份教程也会教你怎么联机😄</p>
<h3 id="局域网联机">局域网联机</h3>
<p>运行客户端程序的设备需要和运行服务端程序的设备位于同一个局域网内（可以有一台设备既运行服务端也运行客户端），接下来，你需要在运行服务端程序的设备上查找到它的ip地址，对于windows用户，你可以使用win+R，输入cmd呼出命令行，然后输入ipconfig，找到自己的<strong>局域网IPv4地址</strong>（一般以192.168或者172.开头），将客户端程序<code>getaddrinfo</code>函数的第一个参数改为该ip地址，接下来就可以联机咯~</p>
<p><img src="ipv4.png" alt="ipv4"></p>
<h3 id="广域网联机">广域网联机</h3>
<p>首先你需要一台具有公网ip的设备，可以是租借的服务器，也可以是你家里有的设备（如果真的有的话），请注意百度出来的ip地址并不一定是你真正的ip地址（多半不是），具体原因由于与本课程无关就不多赘述，感兴趣的同学可以自己查阅学习。接下来的操作非常类似，将客户端程序<code>getaddrinfo</code>函数的第一个参数改为该ip地址即可</p>

                    </div>
                    
                    
                    <div class="after-post-tags">
                        <ul class="tags">
                        
                        </ul>
                    </div>
                    
                    
                    
                    <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
                    
                    
                    <div class="clearfix"></div>
                    </div>
                    
                </div>
                
            </div>
        </div>
        
        
<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
                           
        </div>
    </div>
</div>

    </div>


            </div>
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
			<div class="d-md-flex align-items-center justify-content-center h-100">
				<h2 class="d-md-block d-none align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
			</div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
			
			<a class="mt-1 mb-1" href="/tags/cpp">cpp</a>
			
			<a class="mt-1 mb-1" href="/tags/drink">drink</a>
			
			<a class="mt-1 mb-1" href="/tags/interesting">interesting</a>
			
			<a class="mt-1 mb-1" href="/tags/web%E5%BC%80%E5%8F%91">web开发</a>
			
			<a class="mt-1 mb-1" href="/tags/%E4%BA%92%E8%81%94%E7%BD%91%E8%AE%A1%E7%AE%97">互联网计算</a>
			
			<a class="mt-1 mb-1" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F">分布式</a>
			
			<a class="mt-1 mb-1" href="/tags/%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E5%9F%BA%E7%A1%80">数据管理基础</a>
			
			<a class="mt-1 mb-1" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95">数据结构与算法</a>
			
		</div>
	</div>
</div>

<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright John Doe - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" rel="noopener" href="https://www.wowthemes.net">Mediumish Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>


        </div>


<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


<script src="https://corax.com.cn/js/mediumish.e4b90c58dfa15ac82caf2edfa01e5fd047e17bc15e6babe5c0e442a4407d0b25.js" integrity="sha256-5LkMWN&#43;hWsgsry7foB5f0Efhe8Fea6vlwORCpEB9CyU="></script>
    </body>
</html>
